{{template "layout" .}}
{{define "content"}}
<div class="max-w-lg mx-auto px-4 py-6">
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>
    {{if and .IsEdit (not .IsClone)}}
    <h2 class="text-lg font-semibold mb-6 text-gray-900 dark:text-white">{{t .Lang "form.edit_title"}}</h2>
    <form method="POST" action="/monitors/{{.Monitor.ID}}" class="space-y-4">
    {{else}}
    <h2 class="text-lg font-semibold mb-6 text-gray-900 dark:text-white">{{t .Lang "form.add_title"}}</h2>
    <form method="POST" action="/monitors" class="space-y-4">
    {{end}}
        <div>
            <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.name"}}</label>
            <input type="text" name="name" required placeholder="{{t .Lang "form.name_placeholder"}}"
                value="{{if .IsEdit}}{{.Monitor.Name}}{{end}}"
                class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
        </div>
        <div>
            <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.type"}}</label>
            <select name="type" id="monitor-type" required
                class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                <option value="http" {{if and .IsEdit (eq .Monitor.Type "http")}}selected{{end}}>HTTP(S)</option>
                <option value="tcp" {{if and .IsEdit (eq .Monitor.Type "tcp")}}selected{{end}}>TCP</option>
                <option value="ping" {{if and .IsEdit (eq .Monitor.Type "ping")}}selected{{end}}>Ping (ICMP)</option>
            </select>
        </div>
        <div>
            <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.target"}}</label>
            <input type="text" name="target" id="monitor-target" required placeholder="{{t .Lang "form.target_placeholder_http"}}"
                value="{{if .IsEdit}}{{.Monitor.Target}}{{end}}"
                class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
        </div>
        <div>
            <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.contact_group"}}</label>
            <select name="group_id"
                class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                <option value="">{{t .Lang "form.none"}}</option>
                {{range .Groups}}
                <option value="{{.ID}}" {{if and $.IsEdit (eq $.Monitor.GroupID .ID)}}selected{{end}}>{{.Name}}</option>
                {{end}}
            </select>
        </div>
        {{if .AllNotifiers}}
        <div>
            <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.notifiers"}}</label>
            <p class="text-xs text-gray-400 dark:text-gray-500 mb-2">{{t .Lang "form.notifiers_hint"}}</p>
            <div class="space-y-2">
                {{range .AllNotifiers}}
                <label class="flex items-center gap-2 text-gray-700 dark:text-gray-300">
                    <input type="checkbox" name="notifier_ids" value="{{.ID}}"
                        {{if index $.SelectedNIDs .ID}}checked{{end}}
                        class="bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded">
                    {{if eq .Type "telegram"}}<span class="px-1.5 py-0.5 rounded bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs font-medium flex-shrink-0">Telegram</span>{{else if eq .Type "webhook"}}<span class="px-1.5 py-0.5 rounded bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 text-xs font-medium flex-shrink-0">Webhook</span>{{end}}
                    {{if .Remark}}<span>{{.Remark}}</span>{{else}}{{if eq .Type "telegram"}}<span>{{.ChatID}}</span>{{else}}<span>{{.URL}}</span>{{end}}{{end}}
                </label>
                {{end}}
            </div>
        </div>
        {{end}}
        <div class="grid grid-cols-3 gap-4">
            <div>
                <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.interval"}}</label>
                <input type="number" name="interval" value="{{if .IsEdit}}{{.Monitor.Interval}}{{else}}60{{end}}" min="5"
                    class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.timeout"}}</label>
                <input type="number" name="timeout" value="{{if .IsEdit}}{{.Monitor.Timeout}}{{else}}5{{end}}" min="1"
                    class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.retries"}}</label>
                <input type="number" name="max_retries" value="{{if .IsEdit}}{{.Monitor.MaxRetries}}{{else}}3{{end}}" min="0"
                    class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.retry_interval"}}</label>
                <input type="number" name="retry_interval" value="{{if .IsEdit}}{{.Monitor.RetryInterval}}{{else}}0{{end}}" min="0"
                    class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">{{t .Lang "form.retry_interval_hint"}}</p>
            </div>
            <div>
                <label class="block text-sm text-gray-500 dark:text-gray-400 mb-1">{{t .Lang "form.reminder_interval"}}</label>
                <input type="number" name="reminder_interval" value="{{if .IsEdit}}{{.Monitor.ReminderInterval}}{{else}}0{{end}}" min="0"
                    class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded px-3 py-2 text-gray-900 dark:text-white focus:outline-none focus:border-blue-500">
                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">{{t .Lang "form.reminder_hint"}}</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <input type="checkbox" name="ignore_tls" id="ignore_tls"
                {{if and .IsEdit .Monitor.IgnoreTLS}}checked{{end}}
                class="bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded">
            <label for="ignore_tls" class="text-sm text-gray-500 dark:text-gray-400">{{t .Lang "form.ignore_tls"}}</label>
        </div>
        <div class="flex gap-3 pt-2">
            {{if and .IsEdit (not .IsClone)}}
            <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded transition-colors">
                {{t .Lang "form.save"}}
            </button>
            {{else}}
            <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded transition-colors">
                {{t .Lang "form.create"}}
            </button>
            {{end}}
            <a href="/" class="text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white px-4 py-2">{{t .Lang "form.cancel"}}</a>
        </div>
    </form>
</div>
<script>
function showToast(msg, type) {
    var c = document.getElementById('toast-container');
    var t = document.createElement('div');
    t.className = 'px-4 py-3 rounded-lg shadow-lg text-sm font-medium max-w-sm cursor-pointer transition-opacity duration-300 ' +
        (type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white');
    t.textContent = msg;
    t.onclick = function() { t.remove(); };
    c.appendChild(t);
    setTimeout(function() {
        t.style.opacity = '0';
        setTimeout(function() { t.remove(); }, 300);
    }, 4000);
}

(function() {
    var placeholders = {
        http: {{toJSON (t .Lang "form.target_placeholder_http")}},
        tcp: {{toJSON (t .Lang "form.target_placeholder_tcp")}},
        ping: {{toJSON (t .Lang "form.target_placeholder_ping")}}
    };
    var typeEl = document.getElementById('monitor-type');
    var targetEl = document.getElementById('monitor-target');
    function update() {
        targetEl.placeholder = placeholders[typeEl.value] || '';
    }
    typeEl.addEventListener('change', update);
    update();
})();

document.querySelectorAll('form[action^="/monitors"]').forEach(function(form) {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        fetch(form.action, {
            method: 'POST',
            body: new URLSearchParams(new FormData(form)),
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            redirect: 'manual'
        }).then(function(resp) {
            if (resp.type === 'opaqueredirect') {
                window.location.href = '/';
                return null;
            }
            return resp.json();
        }).then(function(data) {
            if (data && data.message) {
                showToast(data.message, 'error');
            }
        }).catch(function() {
            form.submit();
        });
    });
});
</script>
{{end}}
